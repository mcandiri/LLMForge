@page "/analytics"
@rendermode InteractiveServer
@inject OrchestrationHistoryService History

<PageTitle>LLMForge - Analytics</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="fw-bold mb-1">Analytics</h2>
                    <p class="text-muted mb-0">Model performance metrics and orchestration history.</p>
                </div>
                <button class="btn btn-sm btn-outline-light" @onclick="Refresh">
                    Refresh
                </button>
            </div>
        </div>
    </div>

    @{
        var history = History.GetHistory();
        var allResponses = history.SelectMany(h => h.Responses).ToList();
        var providerNames = allResponses.Select(r => r.Provider).Distinct().ToList();
        var modelStats = providerNames.Select(p =>
        {
            var responses = allResponses.Where(r => r.Provider == p).ToList();
            var wins = responses.Count(r => r.IsWinner);
            return new
            {
                Name = p,
                TotalRequests = responses.Count,
                AvgLatency = responses.Average(r => r.ResponseTime.TotalMilliseconds),
                WinRate = responses.Count > 0 ? (double)wins / responses.Count : 0,
                AvgScore = responses.Average(r => r.Score),
                AvgTokens = (int)responses.Average(r => r.Tokens)
            };
        }).ToList();
    }

    <!-- Performance Summary Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card bg-card border-subtle">
                <div class="card-body text-center">
                    <h3 class="fw-bold text-accent mb-1">@providerNames.Count</h3>
                    <small class="text-muted">Tracked Models</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-card border-subtle">
                <div class="card-body text-center">
                    <h3 class="fw-bold text-accent mb-1">@allResponses.Count</h3>
                    <small class="text-muted">Total Responses</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-card border-subtle">
                <div class="card-body text-center">
                    <h3 class="fw-bold text-accent mb-1">
                        @if (history.Count > 0)
                        {
                            @(history.Average(h => h.BestScore).ToString("F2"))
                        }
                        else
                        {
                            <text>--</text>
                        }
                    </h3>
                    <small class="text-muted">Avg Best Score</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-card border-subtle">
                <div class="card-body text-center">
                    <h3 class="fw-bold text-accent mb-1">@history.Count</h3>
                    <small class="text-muted">Orchestrations</small>
                </div>
            </div>
        </div>
    </div>

    @if (providerNames.Count > 0)
    {
        <!-- Model Comparison Table -->
        <div class="card bg-card border-subtle mb-4">
            <div class="card-body">
                <h6 class="fw-semibold mb-3">Model Comparison</h6>
                <div class="table-responsive">
                    <table class="table table-dark table-sm table-hover mb-0">
                        <thead>
                            <tr class="text-muted">
                                <th class="border-subtle">Model</th>
                                <th class="border-subtle text-end">Requests</th>
                                <th class="border-subtle text-end">Avg Latency</th>
                                <th class="border-subtle text-end">Win Rate</th>
                                <th class="border-subtle text-end">Avg Score</th>
                                <th class="border-subtle text-end">Avg Tokens</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var model in modelStats.OrderByDescending(m => m.WinRate))
                            {
                                <tr>
                                    <td class="border-subtle fw-semibold">@model.Name</td>
                                    <td class="border-subtle text-end">@model.TotalRequests</td>
                                    <td class="border-subtle text-end">@(model.AvgLatency.ToString("F0"))ms</td>
                                    <td class="border-subtle text-end">
                                        <span class="@(model.WinRate >= 0.3 ? "text-accent" : "text-muted")">
                                            @((model.WinRate * 100).ToString("F0"))%
                                        </span>
                                    </td>
                                    <td class="border-subtle text-end">@(model.AvgScore.ToString("F2"))</td>
                                    <td class="border-subtle text-end">@model.AvgTokens</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Bar Charts -->
        <div class="row g-3 mb-4">
            <!-- Win Rate Chart -->
            <div class="col-md-6">
                <div class="card bg-card border-subtle h-100">
                    <div class="card-body">
                        <h6 class="fw-semibold mb-3">Win Rate</h6>
                        @foreach (var model in modelStats.OrderByDescending(m => m.WinRate))
                        {
                            <div class="mb-2">
                                <div class="d-flex justify-content-between small mb-1">
                                    <span>@model.Name</span>
                                    <span class="text-accent">@((model.WinRate * 100).ToString("F0"))%</span>
                                </div>
                                <div class="chart-bar-container">
                                    <div class="chart-bar chart-bar-accent"
                                         style="width: @(Math.Max(model.WinRate * 100, 2).ToString("F0"))%"></div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Average Latency Chart -->
            <div class="col-md-6">
                <div class="card bg-card border-subtle h-100">
                    <div class="card-body">
                        <h6 class="fw-semibold mb-3">Average Latency</h6>
                        @{
                            var maxLatency = modelStats.Count > 0 ? modelStats.Max(m => m.AvgLatency) : 1;
                        }
                        @foreach (var model in modelStats.OrderBy(m => m.AvgLatency))
                        {
                            var pct = maxLatency > 0 ? (model.AvgLatency / maxLatency * 100) : 0;
                            <div class="mb-2">
                                <div class="d-flex justify-content-between small mb-1">
                                    <span>@model.Name</span>
                                    <span class="text-muted">@(model.AvgLatency.ToString("F0"))ms</span>
                                </div>
                                <div class="chart-bar-container">
                                    <div class="chart-bar chart-bar-latency"
                                         style="width: @(Math.Max(pct, 2).ToString("F0"))%"></div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Average Score Chart -->
            <div class="col-md-6">
                <div class="card bg-card border-subtle h-100">
                    <div class="card-body">
                        <h6 class="fw-semibold mb-3">Average Score</h6>
                        @foreach (var model in modelStats.OrderByDescending(m => m.AvgScore))
                        {
                            <div class="mb-2">
                                <div class="d-flex justify-content-between small mb-1">
                                    <span>@model.Name</span>
                                    <span class="text-accent">@(model.AvgScore.ToString("F2"))</span>
                                </div>
                                <div class="chart-bar-container">
                                    <div class="chart-bar chart-bar-accent"
                                         style="width: @(Math.Max(model.AvgScore * 100, 2).ToString("F0"))%"></div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Average Tokens Chart -->
            <div class="col-md-6">
                <div class="card bg-card border-subtle h-100">
                    <div class="card-body">
                        <h6 class="fw-semibold mb-3">Average Tokens</h6>
                        @{
                            var maxTokens = modelStats.Count > 0 ? modelStats.Max(m => m.AvgTokens) : 1;
                        }
                        @foreach (var model in modelStats.OrderBy(m => m.AvgTokens))
                        {
                            var pct = maxTokens > 0 ? ((double)model.AvgTokens / maxTokens * 100) : 0;
                            <div class="mb-2">
                                <div class="d-flex justify-content-between small mb-1">
                                    <span>@model.Name</span>
                                    <span class="text-muted">@model.AvgTokens</span>
                                </div>
                                <div class="chart-bar-container">
                                    <div class="chart-bar chart-bar-success"
                                         style="width: @(Math.Max(pct, 2).ToString("F0"))%"></div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="card bg-card border-subtle mb-4">
            <div class="card-body text-center py-5">
                <h5 class="text-muted mb-2">No analytics data yet</h5>
                <p class="text-secondary small">Run some orchestrations in the Playground or Pipeline Builder to generate performance data.</p>
                <a href="/playground" class="btn btn-sm btn-outline-light mt-2">Go to Playground</a>
            </div>
        </div>
    }

    <!-- Recent Orchestration History -->
    <div class="card bg-card border-subtle">
        <div class="card-body">
            <h6 class="fw-semibold mb-3">Recent Orchestration History</h6>
            @if (history.Count > 0)
            {
                <div class="table-responsive">
                    <table class="table table-dark table-sm table-hover mb-0">
                        <thead>
                            <tr class="text-muted">
                                <th class="border-subtle">Time</th>
                                <th class="border-subtle">Prompt</th>
                                <th class="border-subtle">Winner</th>
                                <th class="border-subtle text-end">Score</th>
                                <th class="border-subtle text-end">Duration</th>
                                <th class="border-subtle text-end">Models</th>
                                <th class="border-subtle text-center">Consensus</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var record in history.Take(20))
                            {
                                <tr>
                                    <td class="border-subtle text-muted small">@record.Timestamp.ToString("HH:mm:ss")</td>
                                    <td class="border-subtle small" style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                        @record.Prompt
                                    </td>
                                    <td class="border-subtle">
                                        <span class="badge bg-accent text-dark">@record.BestProvider</span>
                                    </td>
                                    <td class="border-subtle text-end small">@(record.BestScore.ToString("F2"))</td>
                                    <td class="border-subtle text-end small">@(record.ExecutionTime.TotalMilliseconds.ToString("F0"))ms</td>
                                    <td class="border-subtle text-end small">@record.TotalModels</td>
                                    <td class="border-subtle text-center">
                                        <span class="badge @(record.ConsensusReached ? "bg-success" : "bg-secondary")">
                                            @(record.ConsensusReached ? "Yes" : "No")
                                        </span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <p class="text-muted small mb-0">No orchestrations have been run in this session yet.</p>
            }
        </div>
    </div>
</div>

@code {
    private void Refresh()
    {
        StateHasChanged();
    }
}
